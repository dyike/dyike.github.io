<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta property="wb:webmaster" content="70a2abf24d0ab33f"><title>Laravel请求生命周期 · 一刻笔记</title><meta name="description" content="Laravel请求生命周期 - ityike"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.dyike.com/atom.xml" title="一刻笔记"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/learn" target="_self" class="nav-list-link">充电</a></li><li class="nav-list-item"><a href="/life" target="_self" class="nav-list-link">生活</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="http://weibo.com/yuanfengyff" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="https://github.com/dyike" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">订阅</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Laravel请求生命周期</h1><div class="post-info">Apr 22, 2017</div><div class="post-content"><p>要想了解Laravel的整个运行流程，那么就需要从入口文件下手，再一步步的往下探索，剥开神秘的面纱。在Laravel框架中入口文件就是public文件夹下的index.php文件。Laravel的生命周期也就是从这里开始的，从这里结束。如此优雅的代码却清晰的展示请求到相应的整个生命周期。不妨先看看index.php的源码吧：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">// 第一块</span></div><div class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/autoload.php'</span>;</div><div class="line"><span class="comment">// 第二块</span></div><div class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</div><div class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</div><div class="line"><span class="comment">// 第三块</span></div><div class="line">$response = $kernel-&gt;handle(</div><div class="line">    $request = Illuminate\Http\Request::capture()</div><div class="line">);</div><div class="line">$response-&gt;send();</div><div class="line"><span class="comment">// 第四块</span></div><div class="line">$kernel-&gt;terminate($request, $response);</div></pre></td></tr></table></figure>
<p>为了分析上面的代码，将代码分为四块：</p>
<ul>
<li><p>第一块</p>
<blockquote>
<p>主要用来实现类的自动加载，注册加载composer自动生成的class loader。</p>
</blockquote>
</li>
<li><p>第二块</p>
<blockquote>
<p>主要来实例化服务容器，Laravel的一些基本服务的注册，核心组件注册等等，当然了也包括容器本身的注册。在注册的过程中服务容器会在对应的属性中记录注册的内容，方便于在程序运行期间提供对应的服务。这部分内容可以称为程序启动准备阶段。</p>
</blockquote>
</li>
<li><p>第三块</p>
<blockquote>
<p>处理请求，用户发送的请求入口文件是index.php，从生成<code>Illuminate\Http\Request</code>实例，交给handle()进行处理。将该$request实例绑定到第二步生成的$app容器上。并发送相应</p>
</blockquote>
</li>
<li><p>第四块</p>
<blockquote>
<p>请求的后期清理处理工作，请求结束并进行回调。</p>
</blockquote>
</li>
</ul>
<h1 id="服务容器的实例化（详谈第二块代码）"><a href="#服务容器的实例化（详谈第二块代码）" class="headerlink" title="服务容器的实例化（详谈第二块代码）"></a>服务容器的实例化（详谈第二块代码）</h1><p>先看看<code>bootstrap\app.php</code>源码：里面有注释</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line"><span class="comment">// 服务容器实例化的过程</span></div><div class="line">$app = <span class="keyword">new</span> Illuminate\Foundation\Application(</div><div class="line">    realpath(<span class="keyword">__DIR__</span>.<span class="string">'/../'</span>)</div><div class="line">);</div><div class="line"><span class="comment">// 向容器绑定了三个核心类服务</span></div><div class="line">$app-&gt;singleton(</div><div class="line">    Illuminate\Contracts\Http\Kernel::class,</div><div class="line">    App\Http\Kernel::class</div><div class="line">);</div><div class="line">$app-&gt;singleton(</div><div class="line">    Illuminate\Contracts\Console\Kernel::class,</div><div class="line">    App\Console\Kernel::class</div><div class="line">);</div><div class="line">$app-&gt;singleton(</div><div class="line">    Illuminate\Contracts\Debug\ExceptionHandler::class,</div><div class="line">    App\Exceptions\Handler::class</div><div class="line">);</div><div class="line"><span class="comment">// 返回服务容器实例</span></div><div class="line"><span class="keyword">return</span> $app;</div></pre></td></tr></table></figure>
<p>关于<code>Illuminate\Foundation\Application.php</code>文件查看源码</p>
<h4 id="应用的基础路径setBasePath"><a href="#应用的基础路径setBasePath" class="headerlink" title="应用的基础路径setBasePath()"></a>应用的基础路径<code>setBasePath()</code></h4><p>设置注册应用的基础路径，并在容器中绑定这些基础基础路径。</p>
<h4 id="注册基础绑定registerBaseBindings"><a href="#注册基础绑定registerBaseBindings" class="headerlink" title="注册基础绑定registerBaseBindings()"></a>注册基础绑定<code>registerBaseBindings()</code></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 向容器注册基础绑定</span></div><div class="line"> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseBindings</span><span class="params">()</span></span></div><div class="line"> &#123;</div><div class="line">     <span class="keyword">static</span>::setInstance(<span class="keyword">$this</span>);</div><div class="line">     <span class="comment">// 向服务共享实例数组中注册量单例服务，</span></div><div class="line">     <span class="comment">// 服务名称分别为`app`和`Illuminate\Container\Container`</span></div><div class="line">     <span class="comment">// 对应的实例对象即为服务容器本身</span></div><div class="line">     <span class="keyword">$this</span>-&gt;instance(<span class="string">'app'</span>, <span class="keyword">$this</span>);</div><div class="line">     <span class="keyword">$this</span>-&gt;instance(Container::class, <span class="keyword">$this</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>主要绑定容器实例本身，服务容器中设置了一个静态变量<code>$instance</code>，该变量是在<code>Illuminate\Container\Container.php</code>中定义,<code>Application</code>类继承了<code>Container</code>类，在<code>Container</code>类中可以通过<code>public static function getInstance()</code>获取服务容器实例。服务容器实例还绑定不同的服务容器别名，记录在<code>$instances</code>共享实例数组（在<code>Container</code>类中）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 在容器中注册一个已经存在的实例作为共享实例</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">instance</span><span class="params">($abstract, $instance)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;removeAbstractAlias($abstract);</div><div class="line"></div><div class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;aliases[$abstract]);</div><div class="line">    <span class="comment">// 检查该类有没有本绑定</span></div><div class="line">    <span class="comment">// 如果已经绑定，将触发向容器注册的反弹回调</span></div><div class="line">    <span class="keyword">$this</span>-&gt;instances[$abstract] = $instance;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;bound($abstract)) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;rebound($abstract);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="注册基础服务提供者registerBaseServiceProviders"><a href="#注册基础服务提供者registerBaseServiceProviders" class="headerlink" title="注册基础服务提供者registerBaseServiceProviders()"></a>注册基础服务提供者<code>registerBaseServiceProviders()</code></h4><p>服务提供者的注册是非常重要的，因为它给服务容器添加各种服务。这里只是注册了最基本的三个服务：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">registerBaseServiceProviders</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> EventServiceProvider(<span class="keyword">$this</span>));</div><div class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> LogServiceProvider(<span class="keyword">$this</span>));</div><div class="line">    <span class="keyword">$this</span>-&gt;register(<span class="keyword">new</span> RoutingServiceProvider(<span class="keyword">$this</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在容器里注册一个服务提供者的方法：<br><code>public function register($provider, $options = [], $force = false)</code></p>
<p>源码阅读分析：</p>
<ul>
<li>首先<code>getProvider($provider)</code>进行判断，如果服务提供者存在则获取这个实例对象。</li>
<li>第二，如果给定$provider是一个string，则通过类名<code>resolveProvider($provider)</code>进行实例对象。</li>
<li>然后，对实例化完成的$provider进行标记为已经注册，<code>markAsRegistered($provider)</code>。</li>
<li>最后，启动规定的服务提供者<code>bootProvider($provider)</code>。</li>
</ul>
<h4 id="注册核心类别名registerCoreContainerAliases"><a href="#注册核心类别名registerCoreContainerAliases" class="headerlink" title="注册核心类别名registerCoreContainerAliases()"></a>注册核心类别名<code>registerCoreContainerAliases()</code></h4><p><code>$aliases</code>数组变量中定义了整个框架的核心服务别名，在解析的过程中需要根据实例化的类或者接口名查找服务别名，然后通过服务别名获取具体的服务。</p>
<p>这里放一张图进行小小的总结：<br> <img src="https://raw.githubusercontent.com/yf92/yf92.github.io/master/images/laravel/程序启动准备阶段.png" alt="程序启动准备阶段"></p>
<h1 id="核心类实例化-Kernel类"><a href="#核心类实例化-Kernel类" class="headerlink" title="核心类实例化(Kernel类)"></a>核心类实例化(Kernel类)</h1><p>为什么要服务容器？服务容器实例化后，就可以通过服务容器自动实例化对象了，可以参考上一篇的<a href="https://www.dyike.com/2017/04/11/inversion-of-control/">服务容器</a>。<br><code>index.php</code>中Kernel类就是通过服务容器自动创建完成的。</p>
<p>在<code>bootstrap\app.php</code>文件中就注册了三个服务，其中包括了这个核心类接口，在注册服务时，服务名一般是接口。注册的服务是具体的类名，这一般是通过反射基础来实例化的，并通过反射机制解决构造函数的依赖关系，参考上篇的服务容器有讲解。</p>
<p>这里说的核心类是指<code>App\Http\Kernel</code>类，这个类只是定义了<code>$middleware</code> ，<code>$middlewareGroups</code> 和 <code>$routeMiddleware</code>是哪个数组属性。这个类是继承<code>Illuminate\Foundation\Http\Kernel</code>类的，不妨看看这个类中的构造函数，不难看出这个构造函数是存在依赖关系，一个是<code>Illuminate\Contracts\Foundation\Application</code>，还有一个是<code>Illuminate\Routing\Router</code>。他们在服务容器初始化的时候都进行了实例化。</p>
<h1 id="请求实例化capture"><a href="#请求实例化capture" class="headerlink" title="请求实例化capture()"></a>请求实例化<code>capture()</code></h1><p>在程序启动准备工作完成了之后，就开始请求的实例化。对于请求就是客户端的发送的一个请求报文。这个对应着<code>Illuminate\Http\Request</code>类的实例对象。请求实例的创建是通过<code>Illuminate\Http\Request</code>类中的<code>capture()</code>函数完成的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建HTTP请求实例</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">capture</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span>::enableHttpMethodParameterOverride();</div><div class="line">    <span class="comment">// 通过Symfony实例创建一个请求实例</span></div><div class="line">    <span class="comment">// 而Symfony请求实例是通过createFromGlobals()静态函数实现的</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::createFromBase(SymfonyRequest::createFromGlobals());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createFromBase</span><span class="params">(SymfonyRequest $request)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> ($request <span class="keyword">instanceof</span> <span class="keyword">static</span>) &#123;</div><div class="line">        <span class="keyword">return</span> $request;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $content = $request-&gt;content;</div><div class="line"></div><div class="line">    $request = (<span class="keyword">new</span> <span class="keyword">static</span>)-&gt;duplicate(</div><div class="line">        $request-&gt;query-&gt;all(), $request-&gt;request-&gt;all(), $request-&gt;attributes-&gt;all(),</div><div class="line">        $request-&gt;cookies-&gt;all(), $request-&gt;files-&gt;all(), $request-&gt;server-&gt;all()</div><div class="line">    );</div><div class="line"></div><div class="line">    $request-&gt;content = $content;</div><div class="line"></div><div class="line">    $request-&gt;request = $request-&gt;getInputSource();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> $request;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 通过PHP全局变量创建一个新的请求实例</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createFromGlobals</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    $server = $_SERVER;</div><div class="line">    <span class="keyword">if</span> (<span class="string">'cli-server'</span> === PHP_SAPI) &#123;</div><div class="line">        <span class="keyword">if</span> (array_key_exists(<span class="string">'HTTP_CONTENT_LENGTH'</span>, $_SERVER)) &#123;</div><div class="line">            $server[<span class="string">'CONTENT_LENGTH'</span>] = $_SERVER[<span class="string">'HTTP_CONTENT_LENGTH'</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (array_key_exists(<span class="string">'HTTP_CONTENT_TYPE'</span>, $_SERVER)) &#123;</div><div class="line">            $server[<span class="string">'CONTENT_TYPE'</span>] = $_SERVER[<span class="string">'HTTP_CONTENT_TYPE'</span>];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $request = <span class="keyword">self</span>::createRequestFromFactory($_GET, $_POST, <span class="keyword">array</span>(), $_COOKIE, $_FILES, $server);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">0</span> === strpos($request-&gt;headers-&gt;get(<span class="string">'CONTENT_TYPE'</span>), <span class="string">'application/x-www-form-urlencoded'</span>)</div><div class="line">        &amp;&amp; in_array(strtoupper($request-&gt;server-&gt;get(<span class="string">'REQUEST_METHOD'</span>, <span class="string">'GET'</span>)), <span class="keyword">array</span>(<span class="string">'PUT'</span>, <span class="string">'DELETE'</span>, <span class="string">'PATCH'</span>))</div><div class="line">    ) &#123;</div><div class="line">        parse_str($request-&gt;getContent(), $data);</div><div class="line">        $request-&gt;request = <span class="keyword">new</span> ParameterBag($data);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> $request;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">createRequestFromFactory</span><span class="params">(array $query = array<span class="params">()</span>, array $request = array<span class="params">()</span>, array $attributes = array<span class="params">()</span>, array $cookies = array<span class="params">()</span>, array $files = array<span class="params">()</span>, array $server = array<span class="params">()</span>, $content = null)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 如果定义了请求工厂方法，则可以将自定义的工厂方法赋值给属性$requestFactory</span></div><div class="line">    <span class="comment">// 否则通过new static来完成请求的实例。</span></div><div class="line">    <span class="comment">// new static语法是后期静态绑定</span></div><div class="line">    <span class="comment">// 参照http://php.net/manual/zh/language.oop5.late-static-bindings.php</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>::$requestFactory) &#123;</div><div class="line">        $request = call_user_func(<span class="keyword">self</span>::$requestFactory, $query, $request, $attributes, $cookies, $files, $server, $content);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!$request <span class="keyword">instanceof</span> <span class="keyword">self</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \LogicException(<span class="string">'The Request factory must return an instance of Symfony\Component\HttpFoundation\Request.'</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> $request;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">static</span>($query, $request, $attributes, $cookies, $files, $server, $content);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="处理请求handle"><a href="#处理请求handle" class="headerlink" title="处理请求handle()"></a>处理请求<code>handle()</code></h1><p>完成了请求实例化自然需要对请求实例进行处理，最终返回响应。请求处理是通过<code>Illuminate\Foundation\Http\Kernel.php</code>中<code>handle()</code>进行的，处理是handle中的<code>sendRequestThroughRouter()</code>方法实现的，通过路由请求实例。而<code>enableHttpMethodParameterOverride()</code>方法会是使能请求拒绝，被使能后在请求过程中添加CSRF保护，服务端发送一个CSRF令牌给客户端，也就是一个cookie,在客户端发送POST请求需要将该令牌发送给服务端，否则拒绝处理该请求。</p>
<h4 id="请求前是不是也要准备一下？"><a href="#请求前是不是也要准备一下？" class="headerlink" title="请求前是不是也要准备一下？"></a>请求前是不是也要准备一下？</h4><p>直接看源码：<br>有6个步骤：环境检测、配置加载、异常处理、Facade注册、服务提供者注册、启动服务，通过<code>bootstrap()</code>方法完成准备工作，会调用服务容器$app实例中<code>bootstrapWith()</code>函数,进而通过<code>$this-&gt;make($bootstrapper)-&gt;bootstrap($this)</code>make方法完成每个准备类的初始化工作，然后调用准备类的<code>bootstrap</code>方法实现准备工作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $bootstrappers = [</div><div class="line">    \Illuminate\Foundation\Bootstrap\LoadEnvironmentVariables::class,</div><div class="line">    \Illuminate\Foundation\Bootstrap\LoadConfiguration::class,</div><div class="line">    \Illuminate\Foundation\Bootstrap\HandleExceptions::class,</div><div class="line">    \Illuminate\Foundation\Bootstrap\RegisterFacades::class,</div><div class="line">    \Illuminate\Foundation\Bootstrap\RegisterProviders::class,</div><div class="line">    \Illuminate\Foundation\Bootstrap\BootProviders::class,</div><div class="line">];</div><div class="line"><span class="comment">// 请求通过中间件和路由转发</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;bootstrap();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</div><div class="line">                -&gt;send($request)</div><div class="line">                -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</div><div class="line">                -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"> * Bootstrap the application for HTTP requests.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;app-&gt;hasBeenBootstrapped()) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;bootstrapWith(<span class="keyword">$this</span>-&gt;bootstrappers());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Illuminate\Foundation\Application.php</span></div><div class="line"><span class="comment">// 执行bootstrap类的数组</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrapWith</span><span class="params">(array $bootstrappers)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;hasBeenBootstrapped = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($bootstrappers <span class="keyword">as</span> $bootstrapper) &#123;</div><div class="line">        <span class="keyword">$this</span>[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapping: '</span>.$bootstrapper, [<span class="keyword">$this</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;make($bootstrapper)-&gt;bootstrap(<span class="keyword">$this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>[<span class="string">'events'</span>]-&gt;fire(<span class="string">'bootstrapped: '</span>.$bootstrapper, [<span class="keyword">$this</span>]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>环境检测和配置加载（这部分略过了）</li>
<li>Facade注册<br>这个怎么理解呢，就是为了美观方便而起的别名，通过别名调用对应实例的属性和方法。这个在很多地方都用到了，比如路由，<code>Route::get()</code>以为是一个Route类，其实不然，只是通过别名实现的。<br>看源码是最好的老师：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Illuminate\Foundation\Bootstrap\RegisterFacades.php</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line">&#123;</div><div class="line">    Facade::clearResolvedInstances();</div><div class="line"></div><div class="line">    Facade::setFacadeApplication($app);</div><div class="line">    <span class="comment">// Illuminate\Foundation\AliasLoader.php（外观自动加载类）</span></div><div class="line">    <span class="comment">// 注意与composer的自动加载类不同</span></div><div class="line">    AliasLoader::getInstance($app-&gt;make(<span class="string">'config'</span>)-&gt;get(<span class="string">'app.aliases'</span>, []))-&gt;register();</div><div class="line">&#125;</div><div class="line"><span class="comment">// Illuminate\Foundation\AliasLoader.php</span></div><div class="line"><span class="comment">// 创建别名加载的实例对象</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getInstance</span><span class="params">(array $aliases = [])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">static</span>::$instance)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">static</span>::$instance = <span class="keyword">new</span> <span class="keyword">static</span>($aliases);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $aliases = array_merge(<span class="keyword">static</span>::$instance-&gt;getAliases(), $aliases);</div><div class="line"></div><div class="line">    <span class="keyword">static</span>::$instance-&gt;setAliases($aliases);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">static</span>::$instance;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 在自动加载栈中注册一个自动加载函数</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (! <span class="keyword">$this</span>-&gt;registered) &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;prependToLoaderStack();</div><div class="line"></div><div class="line">        <span class="keyword">$this</span>-&gt;registered = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要分要两个步骤：完成外观自动加载类的实例化并将外观别名数组添加到实例中，然后完成外观自动加载类中自动加载函数的添加。</p>
<p>在laravel中有两个别名，一个是容器核心别名，定义在Application类中，而存储在中Application实例的$aliases属性中，另一个是外观别名，定义在app.php配置文件中，程序运行后存储在AliasLoader类实例中的$aliases属性中。</p>
<p>那像<code>Route::get()</code>是怎么调用的呢？程序首先需要加载类Route，注册了外观别名，那么自动加载栈的第一个函数是AliasLoader类的load()函数，此函数会查找外观别名对应的类名，也就是<code>Illuminate\Support\Facades\Route</code>类，加载这个类，执行get()方法，但是这个类中并没有此静态方法。这个类继承<code>Illuminate\Support\Facades\Facade</code>，也没有get()方法，但是有一个<code>__callStatic()</code>魔术方法，然后调用一个<code>getFacadeAccessor()</code>静态方法，每一个具体的外观类都需要这个静态方法，该方法就是返回别名类所对应的在服务容器中的名称，对于<code>Illuminate\Support\Facades\Route</code>返回的就是“router”，接着通过服务容器获取对应的实例对象，这里对应的<code>Illuminate\Routing\Router</code>类的实例，通过<code>static::$app[$name]</code>实现，最终调用这个类中的get()方法。</p>
<ul>
<li>服务提供者注册<br>服务提供注册这位应用程序提供服务支持，在启动的准备阶段进行了基础服务提供者的加载，但这些服务职能应对前期的启动阶段，对于后期请求处理需要用到的数据库服务、认证服务、session服务还不够。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 服务提供者注册</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line">&#123;</div><div class="line">    $app-&gt;registerConfiguredProviders();</div><div class="line">&#125;</div><div class="line"><span class="comment">// Illuminate\Foundation\Application.php</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">registerConfiguredProviders</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    (<span class="keyword">new</span> ProviderRepository(<span class="keyword">$this</span>, <span class="keyword">new</span> Filesystem, <span class="keyword">$this</span>-&gt;getCachedServicesPath()))</div><div class="line">                -&gt;load(<span class="keyword">$this</span>-&gt;config[<span class="string">'app.providers'</span>]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>启动服务<br>服务提供者必须要实现<code>register()</code>函数，还有一个<code>boot()</code>函数根据需求实现，主要用于启动服务，不是必须的，不实现会在父类中统一处理。对于实现boot()函数的服务提供者，会通过BootProviders类进行统一管理调用。要实现boot()也比较简短，只需要调用服务容器中的boot()函数即可。</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Illuminate\Foundation\Bootstrap.php</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bootstrap</span><span class="params">(Application $app)</span></span></div><div class="line">&#123;</div><div class="line">    $app-&gt;boot();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h4><p>在Laravel程序中有中间件的概念，就是对请求的处理，首先是经过中间的处理，然后经过路由的处理，最终到控制器生成响应。这个过程中基本是以装饰者模式的思想进行的。<br>看看app/Http/Kernel.php源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> $middleware = [</div><div class="line">    \Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class,</div><div class="line">    \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,</div><div class="line">    \App\Http\Middleware\TrimStrings::class,</div><div class="line">    \Illuminate\Foundation\Http\Middleware\ConvertEmptyStringsToNull::class,</div><div class="line">];</div><div class="line"></div><div class="line"><span class="comment">// Illuminate\Foundation\Http\Kernel.php</span></div><div class="line"><span class="comment">// 将请求通过中间件和路由处理</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendRequestThroughRouter</span><span class="params">($request)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line">    Facade::clearResolvedInstance(<span class="string">'request'</span>);</div><div class="line">    <span class="keyword">$this</span>-&gt;bootstrap();</div><div class="line">    <span class="comment">// 主要看这里</span></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;app))</div><div class="line">                -&gt;send($request)</div><div class="line">                -&gt;through(<span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : <span class="keyword">$this</span>-&gt;middleware)</div><div class="line">                -&gt;then(<span class="keyword">$this</span>-&gt;dispatchToRouter());</div><div class="line">&#125;</div><div class="line"><span class="comment">// 设置路由分发回调函数</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Illuminate\Pipeline\Pipeline.php</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Container $container = null)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;container = $container;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 设置被送入管道的对象</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">($passable)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;passable = $passable;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 设置导管数组</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">through</span><span class="params">($pipes)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;pipes = is_array($pipes) ? $pipes : func_get_args();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 以一个回调函数为重点执行管道处理</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">then</span><span class="params">(Closure $destination)</span></span></div><div class="line">&#123;</div><div class="line">    $pipeline = array_reduce(</div><div class="line">        <span class="comment">// 可以看看carry()</span></div><div class="line">        array_reverse(<span class="keyword">$this</span>-&gt;pipes), <span class="keyword">$this</span>-&gt;carry(), <span class="keyword">$this</span>-&gt;prepareDestination($destination)</div><div class="line">    );</div><div class="line">    <span class="keyword">return</span> $pipeline(<span class="keyword">$this</span>-&gt;passable);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="路由处理生成响应"><a href="#路由处理生成响应" class="headerlink" title="路由处理生成响应"></a>路由处理生成响应</h4><p>回到刚才看到的路由分发回调函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRouter</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;app-&gt;instance(<span class="string">'request'</span>, $request);</div><div class="line">        <span class="comment">// 将请求信息传递给路由信息存储实例</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;router-&gt;dispatch($request);</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Illuminate\Routing\Router.php</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(Request $request)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;currentRequest = $request;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;dispatchToRoute($request);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 分发请求到路由上，并返回响应</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchToRoute</span><span class="params">(Request $request)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 查找对应的路由实例</span></div><div class="line">    $route = <span class="keyword">$this</span>-&gt;findRoute($request);</div><div class="line">    $request-&gt;setRouteResolver(<span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> $route;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">$this</span>-&gt;events-&gt;dispatch(<span class="keyword">new</span> Events\RouteMatched($route, $request));</div><div class="line"></div><div class="line">    $response = <span class="keyword">$this</span>-&gt;runRouteWithinStack($route, $request);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse($request, $response);</div><div class="line">&#125;</div><div class="line"><span class="comment">// 通过一个实例栈运行给定的路由</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">runRouteWithinStack</span><span class="params">(Route $route, Request $request)</span></span></div><div class="line">&#123;</div><div class="line">    $shouldSkipMiddleware = <span class="keyword">$this</span>-&gt;container-&gt;bound(<span class="string">'middleware.disable'</span>) &amp;&amp;</div><div class="line">                            <span class="keyword">$this</span>-&gt;container-&gt;make(<span class="string">'middleware.disable'</span>) === <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    $middleware = $shouldSkipMiddleware ? [] : <span class="keyword">$this</span>-&gt;gatherRouteMiddleware($route);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> Pipeline(<span class="keyword">$this</span>-&gt;container))</div><div class="line">                    -&gt;send($request)</div><div class="line">                    -&gt;through($middleware)</div><div class="line">                    -&gt;then(<span class="function"><span class="keyword">function</span> <span class="params">($request)</span> <span class="title">use</span> <span class="params">($route)</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prepareResponse(</div><div class="line">                            $request, $route-&gt;run()</div><div class="line">                        );</div><div class="line">                    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>路由的信息都会保存在一个<code>Illuminate\Routing\Router</code>类实例中，而这个类实例存储在kernel类中。</p>
<p>查到请求对应的路由后，请求传递给对应的路由去处理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Illuminate\Routing\Route.php</span></div><div class="line"><span class="comment">// 执行路由动作并返回相应</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;container = <span class="keyword">$this</span>-&gt;container ?: <span class="keyword">new</span> Container;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;isControllerAction()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runController();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;runCallable();</div><div class="line">    &#125; <span class="keyword">catch</span> (HttpResponseException $e) &#123;</div><div class="line">        <span class="keyword">return</span> $e-&gt;getResponse();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>进而交给相应的controller去处理。这部分，首先根据控制器类名通过服务容器进行实例化，再通过调用控制的实例对应的方法来生成响应的主体部分（并非最终的响应）。经过一系列的处理之后生成响应。响应是封装在<code>Illuminate\Http\Response</code>实例中的。</p>
<h1 id="响应的发送和请求生命周期的终止"><a href="#响应的发送和请求生命周期的终止" class="headerlink" title="响应的发送和请求生命周期的终止"></a>响应的发送和请求生命周期的终止</h1><h4 id="响应发送-response-gt-send"><a href="#响应发送-response-gt-send" class="headerlink" title="响应发送$response-&gt;send()"></a>响应发送<code>$response-&gt;send()</code></h4><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Symfony\Component\HttpFoundation\Response.php</span></div><div class="line"><span class="comment">// 发送 HTTP响应头和内容</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 发送HTTP头部</span></div><div class="line">    <span class="keyword">$this</span>-&gt;sendHeaders();</div><div class="line">    <span class="comment">// 发送Web响应的内容</span></div><div class="line">    <span class="keyword">$this</span>-&gt;sendContent();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (function_exists(<span class="string">'fastcgi_finish_request'</span>)) &#123;</div><div class="line">        fastcgi_finish_request();</div><div class="line">    &#125; <span class="keyword">elseif</span> (<span class="string">'cli'</span> !== PHP_SAPI) &#123;</div><div class="line">        <span class="keyword">static</span>::closeOutputBuffers(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="程序终止——生命周期的最后阶段-kernel-gt-terminate-request-response"><a href="#程序终止——生命周期的最后阶段-kernel-gt-terminate-request-response" class="headerlink" title="程序终止——生命周期的最后阶段$kernel-&gt;terminate($request, $response)"></a>程序终止——生命周期的最后阶段<code>$kernel-&gt;terminate($request, $response)</code></h4><p>程序终止，完成终止中间件的调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Illuminate\Foundation\Http\Kernel.php</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">terminate</span><span class="params">($request, $response)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">$this</span>-&gt;terminateMiddleware($request, $response);</div><div class="line"></div><div class="line">    <span class="keyword">$this</span>-&gt;app-&gt;terminate();</div><div class="line">&#125;</div><div class="line"><span class="comment">// 终止中间件</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">terminateMiddleware</span><span class="params">($request, $response)</span></span></div><div class="line">&#123;</div><div class="line">    $middlewares = <span class="keyword">$this</span>-&gt;app-&gt;shouldSkipMiddleware() ? [] : array_merge(</div><div class="line">        <span class="keyword">$this</span>-&gt;gatherRouteMiddleware($request),</div><div class="line">        <span class="keyword">$this</span>-&gt;middleware</div><div class="line">    );</div><div class="line"></div><div class="line">    <span class="keyword">foreach</span> ($middlewares <span class="keyword">as</span> $middleware) &#123;</div><div class="line">        <span class="keyword">if</span> (! is_string($middleware)) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">list</span>($name, $parameters) = <span class="keyword">$this</span>-&gt;parseMiddleware($middleware);</div><div class="line"></div><div class="line">        $instance = <span class="keyword">$this</span>-&gt;app-&gt;make($name);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (method_exists($instance, <span class="string">'terminate'</span>)) &#123;</div><div class="line">            $instance-&gt;terminate($request, $response);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>什么东西都是有始有终的，至此请求生命周期结束。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><blockquote>
<p>请求到响应整个执行过程，可以分为四个阶段：程序启动准备阶段，请求实例化阶段，请求处理阶段，响应发送和终止程序。<br>准备阶段：完成一些文件自动加载，服务容器实例化，基础服务提供者注册和Kernel类的实例化。<br>请求实例化阶段：将请求信息以对象的实行进行存储。<br>请求处理阶段：准备请求处理环境，完成环境和配置加载等6大东西。通过中间件处理通过路由和控制器处理，生成相应。<br>请求终止阶段：将响应发送给客户端并终止程序。</p>
</blockquote>
</div></article></div></main><footer><div class="paginator"><a href="/2017/04/11/inversion-of-control/" class="next">下一篇</a></div><script type="text/javascript">(function(){
    var url = "http://widget.weibo.com/distribution/comments.php?width=0&url=auto&border=1&brandline=y&appkey=2308493083&dpc=1";
    url = url.replace("url=auto", "url=" + encodeURIComponent(document.URL));
    document.write('<iframe id="WBCommentFrame" src="' + url + '" scrolling="no" frameborder="0" style="width:100%"></iframe>');
})();</script><script src="http://tjs.sjs.sinajs.cn/open/widget/js/widget/comment.js" type="text/javascript" charset="utf-8"></script><script type="text/javascript">window.WBComment.init({
"id": "WBCommentFrame"</script>});<div class="copyright"><p>© 2013 - 2017 <a href="http://www.dyike.com">ityike</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>