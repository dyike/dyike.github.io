<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta property="wb:webmaster" content="70a2abf24d0ab33f"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><title>生成Charts图片，并发送Charts图片邮件 · 一刻笔记</title><meta name="description" content="生成Charts图片，并发送Charts图片邮件 - ityike"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/touxiang.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://www.dyike.com/atom.xml" title="一刻笔记"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/touxiang.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="/learn" target="_self" class="nav-list-link">充电</a></li><li class="nav-list-item"><a href="/life" target="_self" class="nav-list-link">生活</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">关于</a></li><li class="nav-list-item"><a href="http://weibo.com/yuanfengyff" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="https://github.com/dyike" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">订阅</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">生成Charts图片，并发送Charts图片邮件</h1><div class="post-info">Oct 16, 2017</div><div class="post-content"><p>CTEmail(Charts and Text Eamil)是一个发送带有图片的邮件的小工具，这个图片是邮件内容中显示，不是添加在附件中，这个脚本实现的比较简单粗暴，不管长相丑陋，只能能解决实际问题就行。</p>
<h2 id="为什么有CTEmail"><a href="#为什么有CTEmail" class="headerlink" title="为什么有CTEmail?"></a>为什么有CTEmail?</h2><ul>
<li>没有一个不懒的程序员，做啥都想着写个脚本跑一下，跑个脚本抢月饼，跑个脚本…能用脚本的干嘛不用脚本。每天的数据报表需要一个邮件脚本发送。</li>
<li>对接了各大厂商，每天每周每月都会往来邮件。报表用图表的形式更简单直观的反馈数据，为什么我们不在邮件中使用图表。</li>
<li>各大厂商的邮件中图表都是小姐姐手动制作，手动发出%&gt;_&lt;%，为什么不跑一个脚本。</li>
<li>如果解决上面的问题，是不是解放了小手。1) 用数据生成图表，2) 将图表拼接到邮件中发出。</li>
</ul>
<p>这个小工具的初衷，解决实际问题还是很重要的。</p>
<h2 id="哪些人需要这个工具？"><a href="#哪些人需要这个工具？" class="headerlink" title="哪些人需要这个工具？"></a>哪些人需要这个工具？</h2><ul>
<li>产品同学，图表是展示数据的最佳实践！</li>
<li>运营同学，图表是展示报表的最佳实践！</li>
<li>技术同学，为了继续懒下去！</li>
<li>…零编程基础的同学都能使用【只要会科学上网就能解决一切】</li>
</ul>
<p>说这些都是没用，那就跟来做一下吧。<br>项目托管在github上，地址：<a href="https://github.com/dyike/CTEmail" target="_blank" rel="external">dyike/CTEmail</a>。记得来star哟！！！</p>
<h2 id="怎么使用？"><a href="#怎么使用？" class="headerlink" title="怎么使用？"></a>怎么使用？</h2><p>首先，稍微知道怎么操作Python，像我这种不会写代码都能操作，你一定也可以。其次是到<a href="https://plot.ly/python/getting-started/" target="_blank" rel="external">Plotly</a>——这是一个可视化数据的工具有点类似于HighCharts，不过支持多种语言，很强大了。先熟悉一下， 然后注册一个账号，后面会用到。本文着重数据生成图表图片。邮件服务配置查看<code>README</code></p>
<h3 id="1st-Step："><a href="#1st-Step：" class="headerlink" title="1st Step："></a>1st Step：</h3><p>将项目clone下来，熟悉项目的结构，里面不到两百行代码，简单粗暴。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> git@github.com:dyike/CTEmail.git</div></pre></td></tr></table></figure>
<p>在<code>send.py</code>文件中配置自己的邮箱账号，密码，邮件标题，邮件模板路径和发送到的邮箱。</p>
<p>邮件模板的默认路径是<code>./content/</code>，会自动读取该路径下的html文件。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> ctemail <span class="keyword">import</span> CTEmail</div><div class="line">e = CTEmail(<span class="string">'Your email acount'</span>, <span class="string">'Your password'</span>)</div><div class="line"><span class="comment"># " ./content/ 邮件文件的路径 "</span></div><div class="line">e.send_email(<span class="string">'Test Email Title'</span>, <span class="string">'./content/'</span>, [<span class="string">'i@ityike.com'</span>])</div></pre></td></tr></table></figure>
<p>默认是配置QQ的STMP发送服务（stmp.qq.com）,端口是25。你也可以配置163.gmail等等，在初始化CTEmail()配置相应的配置即可。</p>
<h3 id="2nd-Step"><a href="#2nd-Step" class="headerlink" title="2nd Step:"></a>2nd Step:</h3><p>项目中提供了一个默认的模板，你可以根据你的实际需求定制的模板，<code>content</code>文件夹下面还有图片资源，我们生成的图表的图片资源也是在该文件夹下面。</p>
<p>需要注意的是，html文件中，将img标签用<email_img>给包了一层，这样只是为了能够方便Python解析，替换。【ps：这里可以了解一下Python发送图片邮件的实现，将图片cid替换进来】<a href="https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001386832745198026a685614e7462fb57dbf733cc9f3ad000" target="_blank" rel="external">参考廖雪峰老师的教程</a> 这里你可以不Care这些事。</email_img></p>
<p>模板中需要注意的一点：也是非常重要的一点就是：html中多个<email_img>标签需要换行。不换行就无法正确解析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;a&gt;&lt;EMAIL_IMG&gt;&lt;img src=&quot;image1.png&quot;&gt;&lt;/EMAIL_IMG&gt;&lt;/a&gt;</div><div class="line">&lt;a&gt;&lt;EMAIL_IMG&gt;&lt;img src=&quot;image2.png&quot;&gt;&lt;/EMAIL_IMG&gt;&lt;/a&gt;</div></pre></td></tr></table></figure></email_img></p>
<h3 id="3th-Step"><a href="#3th-Step" class="headerlink" title="3th Step:"></a>3th Step:</h3><p>快要结束了，本文的却重点来了，不要慌，也很简单。就是使用Plotly，关于使用离线（本地）模式还是在线模式，看自己实际需求。我这里说在线的。因为我用的是定时脚本，我只能调用在线的API生成图片保存到本地<code>content</code>文件夹下面。</p>
<ul>
<li><p>安装Plotly</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install plotly</div></pre></td></tr></table></figure>
</li>
<li><p><code>get_img.py</code>文件,文件名可以重命名，里面需要的配置你的认证信息credentials，信息在<code>https://plot.ly/settings/api</code>中查看。有两种方式：第一种如下<br>设置username和api_key。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> plotly </div><div class="line">plotly.tools.set_credentials_file(username=<span class="string">'DemoAccount'</span>, api_key=<span class="string">'lr1c37zw81'</span>)</div></pre></td></tr></table></figure>
<p>或者在安装完成后，在<code>~/.plotly/.credentials</code>文件中配置你的账号信息。<br>看到的信息大致如下：修改对应的即可。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"username"</span>: <span class="string">"DemoAccount"</span>,</div><div class="line">    <span class="attr">"stream_ids"</span>: [<span class="string">"ylosqsyet5"</span>, <span class="string">"h2ct8btk1s"</span>, <span class="string">"oxz4fm883b"</span>],</div><div class="line">    <span class="attr">"api_key"</span>: <span class="string">"lr1c37zw81"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>继续<code>get_img.py</code>文件<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> plotly.plotly <span class="keyword">as</span> py</div><div class="line"><span class="keyword">import</span> plotly.graph_objs <span class="keyword">as</span> go</div><div class="line"></div><div class="line">py.sign_in(<span class="string">'Your account'</span>, <span class="string">'API Token'</span>) <span class="comment"># 注意：这里是plotly网站的用户名和密码</span></div><div class="line"></div><div class="line">trace = go.Bar(x=[<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>], y= [<span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>])</div><div class="line">data = [trace]</div><div class="line">layout = go.Layout(title=<span class="string">'A Simple Plot'</span>, width=<span class="number">800</span>, height=<span class="number">640</span>)</div><div class="line">fig = go.Figure(data=data, layout=layout)</div><div class="line"><span class="comment"># 保存图片文件的路径</span></div><div class="line">py.image.save_as(fig, filename=<span class="string">'./content/image1.png'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 拼接模板文件</span></div><div class="line">template = <span class="string">'&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset="UTF-8"&gt;&lt;/head&gt;&lt;body&gt;'</span> + <span class="string">"\n"</span> + <span class="string">'&lt;a&gt;&lt;EMAIL_IMG&gt;&lt;img src="image1.png"&gt;&lt;/EMAIL_IMG&gt;&lt;/a&gt;'</span> + <span class="string">"\n"</span> + <span class="string">'&lt;a&gt;&lt;EMAIL_IMG&gt;&lt;img src="image2.png"&gt;&lt;/EMAIL_IMG&gt;&lt;/a&gt;'</span> + <span class="string">"\n"</span> + <span class="string">'&lt;/body&gt;&lt;/html&gt;'</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> template</div></pre></td></tr></table></figure>
</li>
</ul>
<p>注意上面拼接模板文件内容的时候使用了换行符<code>&quot;\n&quot;</code>,为什么这样使用，一简单粗暴，二为了引起重视【这里有坑】。</p>
<ul>
<li><p>执行上面的脚本文件<code>python get_img.py &gt; ./content/index.html</code> 这样就可以将模板文件写入到<code>content</code>目录下的<code>index.html</code></p>
</li>
<li><p>执行<code>python send.py</code>邮件就可以发送邮件，将上面的几个命令写入到shell脚本中,更新方便快捷。</p>
</li>
<li><p>其他图表的生成也可以参考官方文档的介绍。</p>
</li>
</ul>
<h3 id="4th-Enjoy-it"><a href="#4th-Enjoy-it" class="headerlink" title="4th Enjoy it!!!"></a>4th Enjoy it!!!</h3><p>放在最后的不是不重要，解决实际问题才是更重要，欢迎来<a href="https://github.com/dyike/CTEmail" target="_blank" rel="external">CTEmail</a>Star！！！</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/09/12/design-pattern-factory-method/" class="next">下一篇</a></div><script type="text/javascript">(function(){
    var url = "http://widget.weibo.com/distribution/comments.php?width=0&url=auto&border=1&brandline=y&appkey=2308493083&dpc=1";
    url = url.replace("url=auto", "url=" + encodeURIComponent(document.URL));
    document.write('<iframe id="WBCommentFrame" src="' + url + '" scrolling="no" frameborder="0" style="width:100%"></iframe>');
})();</script><script src="https://tjs.sjs.sinajs.cn/open/widget/js/widget/comment.js" type="text/javascript" charset="utf-8"></script><script type="text/javascript">window.WBComment.init({
    "id": "WBCommentFrame"
});</script><div class="copyright"><p>© 2013 - 2017 <a href="http://www.dyike.com">ityike</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>